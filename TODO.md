# TODO: Реализация парсинга подписчиков Telegram канала

## Общее описание
Реализация функции активного парсинга подписчиков канала при его добавлении через админ-панель. Система будет автоматически собирать данные о пользователях, анализировать возможность отправки личных сообщений и предоставлять статистику админу.

## Этап 1: Подготовка инфраструктуры и утилит
**Цель:** Создать базовые утилиты для парсинга и работы с Pyrogram

### 1.1. Создать модуль `utils/channel_parser.py`
- [ ] Реализовать функцию `parse_channel_subscribers()` для получения списка участников канала через Pyrogram
- [ ] Добавить обработку ошибок (права доступа, ограничения API, сетевые ошибки)
- [ ] Реализовать поэтапный парсинг с задержками для больших каналов (ограничения Telegram API)
- [ ] Добавить логгирование процесса парсинга
- [ ] Реализовать фильтрацию ботов и неактивных пользователей
- [ ] Добавить сбор статистики (с username/без username, активность)

### 1.2. Расширить `database/database.py`
- [ ] Добавить функцию `bulk_add_channel_subscribers()` для массового добавления подписчиков
- [ ] Реализовать функцию `get_channel_subscribers_stats()` для получения статистики по каналу
- [ ] Добавить функцию `clear_channel_subscribers()` для очистки данных подписчиков канала
- [ ] Реализовать batch-вставку для оптимизации производительности
- [ ] Добавить функцию `update_existing_subscribers()` для обновления существующих записей

### 1.3. Тесты для Этапа 1
- [ ] Написать тесты для `channel_parser.py` с моками Pyrogram (`tests/test_channel_parser.py`)
- [ ] Написать тесты для `bulk_add_channel_subscribers()` в `tests/database/test_database.py`
- [ ] Проверить интеграцию через `pytest`
- [ ] Написать тесты обработки ошибок и edge cases

## Этап 2: Расширение состояний и обработчиков
**Цель:** Интегрировать парсинг в процесс добавления канала

### 2.1. Обновить `states/admin_states.py`
- [ ] Добавить состояние `AdminStates.parsing_channel`
- [ ] Добавить состояние для хранения промежуточных данных парсинга
- [ ] Добавить состояния для отслеживания прогресса парсинга

### 2.2. Модифицировать `handlers/admin_handlers.py`
- [ ] Добавить этап парсинга после успешного добавления канала в БД
- [ ] Реализовать обработку состояния `parsing_channel`
- [ ] Добавить кнопку отмены парсинга
- [ ] Реализовать отправку статистики админу после завершения парсинга
- [ ] Добавить обработку ошибок парсинга с понятными сообщениями

### 2.3. Обновить клавиатуры в `utils/keyboards.py`
- [ ] Добавить кнопку "Начать парсинг подписчиков"
- [ ] Добавить клавиатуру статуса парсинга с прогрессом
- [ ] Добавить кнопку "Отменить парсинг"
- [ ] Реализовать клавиатуру с результатами парсинга

### 2.4. Обновить тексты в `texts/messages.py`
- [ ] Добавить тексты для сообщений о парсинге
- [ ] Добавить тексты для статистики парсинга
- [ ] Добавить тексты ошибок парсинга
- [ ] Добавить тексты прогресса парсинга

### 2.5. Тесты для Этапа 2
- [ ] Тесты на корректность новых состояний FSM
- [ ] Тесты на обработку команды парсинга
- [ ] Интеграционные тесты с Pyrogram моками
- [ ] Тесты на отмену парсинга

## Этап 3: Улучшение пользовательского опыта
**Цель:** Сделать процесс парсинга интерактивным и информативным

### 3.1. Реализовать прогресс-бар парсинга
- [ ] Добавить промежуточные сообщения о прогрессе (10%, 25%, 50%, 75%, 100%)
- [ ] Реализовать обновление сообщения с текущим статусом
- [ ] Добавить информацию о скорости парсинга (пользователей/сек)
- [ ] Реализовать ETA (estimated time of arrival) для больших каналов

### 3.2. Расширить статистику в отчете
- [ ] Добавить информацию о новых/существующих подписчиках
- [ ] Реализовать разбивку по активности (давно не онлайн, если возможно)
- [ ] Добавить информацию о бота/реальных пользователях (если возможно через API)
- [ ] Реализовать визуализацию статистики (текстовые графики)
- [ ] Добавить информацию о пользователях с открытыми/закрытыми профилями

### 3.3. Добавить команду ручного парсинга
- [ ] Команда `/parse_channel <channel_id>` для повторного парсинга существующих каналов
- [ ] Команда `/parse_all_channels` для парсинга всех добавленных каналов
- [ ] Валидация прав доступа к каналу
- [ ] Обработка существующих данных (обновление/добавление/удаление)

### 3.4. Тесты для Этапа 3
- [ ] Тесты прогресс-индикации
- [ ] Тесты расширенной статистики
- [ ] Тесты команды ручного парсинга
- [ ] Тесты обновления существующих данных

## Этап 4: Обработка edge-кейсов и оптимизация
**Цель:** Обеспечить стабильность и производительность

### 4.1. Реализовать обработку ограничений Telegram API
- [ ] Добавить rate limiting для запросов get_chat_members
- [ ] Реализовать продолжение парсинга после ограничений (429 Too Many Requests)
- [ ] Добавить exponential backoff при ошибках сети
- [ ] Реализовать паузу и продолжение парсинга

### 4.2. Добавить фоновую синхронизацию
- [ ] Реализовать периодическую синхронизацию подписчиков (раз в неделю)
- [ ] Добавить задачу в APScheduler для автоматического обновления данных
- [ ] Реализовать инкрементальное обновление (только изменения)
- [ ] Добавить опцию синхронизации по расписанию

### 4.3. Оптимизация работы с БД
- [ ] Реализовать batch-вставку для массового добавления (пакетами по 100-500 записей)
- [ ] Добавить индексы для ускорения поиска подписчиков
- [ ] Оптимизировать запросы статистики с использованием агрегатных функций
- [ ] Реализовать кэширование часто запрашиваемых данных

### 4.4. Мониторинг и диагностика
- [ ] Добавить логгирование детальной статистики парсинга
- [ ] Реализовать команду `/parsing_stats` для просмотра статистики парсингов
- [ ] Добавить мониторинг использования памяти при парсинге больших каналов
- [ ] Реализовать graceful degradation при нехватке ресурсов

### 4.5. Тесты для Этапа 4
- [ ] Тесты обработки rate limiting
- [ ] Тесты фоновой синхронизации
- [ ] Тесты производительности батч-вставок
- [ ] Тесты восстановления после сбоев

## Этап 5: Документация и финальные проверки
**Цель:** Завершить реализацию и обеспечить качество

### 5.1. Обновить документацию
- [ ] Обновить `docs/DATABASE.md` с описанием новых функций
- [ ] Обновить `docs/HANDLERS.md` с описанием процесса парсинга
- [ ] Добавить раздел в `KODA.md` о новой функциональности
- [ ] Создать `docs/PARSING.md` с полным описанием системы парсинга

### 5.2. Написать интеграционные тесты
- [ ] Тесты полного потока: добавление канала → парсинг → статистика
- [ ] Тесты с реальными данными (test каналы)
- [ ] Тесты восстановления после сбоев
- [ ] Тесты параллельного парсинга нескольких каналов

### 5.3. Провести регрессионное тестирование
- [ ] Убедиться, что существующие функции работы с каналами работают корректно
- [ ] Проверить совместимость с текущей структурой БД
- [ ] Проверить производительность на каналах разного размера (100, 1000, 10000 пользователей)
- [ ] Проверить работу с ограниченными правами доступа

### 5.4. Финальные проверки
- [ ] Запустить все тесты: `pytest -v`
- [ ] Проверить линтером: `ruff check .`
- [ ] Проверить типы: `mypy .` (если настроено)
- [ ] Протестировать вручную все сценарии использования
- [ ] Проверить потребление памяти и производительность

## Приоритеты выполнения

### Высокий приоритет (MVP - Минимально жизнеспособный продукт):
- Этап 1.1: Базовая функция парсинга подписчиков
- Этап 1.2: Функции для работы с БД
- Этап 2.1: Новые состояния FSM
- Этап 2.2: Интеграция в процесс добавления канала
- Базовые тесты (Этап 1.3)

### Средний приоритет (Улучшения):
- Этап 2.3-2.4: UX улучшения
- Этап 3.1-3.2: Прогресс и расширенная статистика
- Этап 3.3: Команды ручного парсинга
- Этап 5.1: Документация

### Низкий приоритет (Оптимизации и продвинутые функции):
- Этап 4.1-4.4: Обработка edge-кейсов и оптимизации
- Этап 4.2: Фоновая синхронизация
- Этап 5.2-5.4: Расширенные тесты и проверки

## Критические зависимости и ограничения

### Зависимости от внешних API:
1. **Pyrogram права доступа**: Бот должен иметь права администратора в канале для получения списка участников через `get_chat_members()`
2. **Telegram API ограничения**: 
   - Максимальное количество участников, которые можно получить за один запрос
   - Rate limiting: ~30 запросов в секунду
   - Ограничения на получение информации о больших каналах
3. **Права пользователя Pyrogram**: Аккаунт, используемый для Pyrogram, должен быть администратором в целевом канале

### Технические ограничения:
1. **Производительность БД**: SQLite может иметь ограничения при работе с большими объемами данных
2. **Память**: Парсинг больших каналов может потреблять значительный объем памяти
3. **Сетевая стабильность**: Нестабильное соединение может прервать процесс парсинга

## Оценка времени

### Оптимистичная оценка:
- Этап 1: 2-3 дня
- Этап 2: 1-2 дня  
- Этап 3: 2-3 дня
- Этап 4: 3-4 дня
- Этап 5: 1-2 дня
- **Итого:** 9-14 дней

### Реалистичная оценка (с учетом тестирования и отладки):
- Этап 1: 3-4 дня
- Этап 2: 2-3 дня  
- Этап 3: 3-4 дня
- Этап 4: 4-5 дней
- Этап 5: 2-3 дня
- **Итого:** 14-19 дней

### Консервативная оценка (с учетом непредвиденных сложностей):
- Этап 1: 4-5 дней
- Этап 2: 3-4 дня  
- Этап 3: 4-5 дней
- Этап 4: 5-7 дней
- Этап 5: 3-4 дня
- **Итого:** 19-25 дней

## Рекомендации по реализации

1. **Начинать с MVP**: Реализовать сначала базовый функционал (Этапы 1 и 2), затем добавлять улучшения
2. **Инкрементальное тестирование**: Тестировать каждый компонент сразу после реализации
3. **Мониторинг производительности**: Следить за потреблением памяти и временем выполнения при парсинге
4. **Обработка ошибок**: Предусмотреть graceful degradation при ошибках API
5. **Документирование**: Вести документацию параллельно с разработкой

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|------------|---------|-----------|
| Ограничения Telegram API | Высокая | Высокое | Реализовать rate limiting, паузы между запросами |
| Недостаточно прав доступа | Средняя | Высокое | Проверять права перед парсингом, понятные сообщения об ошибках |
| Проблемы с производительностью БД | Средняя | Среднее | Использовать batch-вставку, оптимизировать индексы |
| Нехватка памяти | Низкая | Высокое | Ограничивать размер батчей, мониторить использование памяти |
| Сетевые проблемы | Средняя | Среднее | Реализовать retry logic, exponential backoff |

## Успешные критерии

1. **Функциональность**:
   - Парсинг запускается автоматически при добавлении канала
   - Сбор статистики о пользователях с username/без username
   - Предоставление понятного отчета админу
   - Обработка ошибок с понятными сообщениями

2. **Производительность**:
   - Парсинг канала с 1000 пользователей завершается за < 5 минут
   - Использование памяти < 100MB при парсинге
   - Batch-вставка в БД работает эффективно

3. **Надежность**:
   - Восстановление после сетевых сбоев
   - Graceful degradation при ограничениях API
   - Корректная обработка edge cases

4. **UX**:
   - Прогресс-индикация для пользователя
   - Возможность отмены парсинга
   - Понятные сообщения об ошибках
   - Удобный просмотр статистики

## Следующие шаги после реализации

1. **Мониторинг использования**: Следить за использованием функции в production
2. **Сбор feedback**: Собирать отзывы от админов об удобстве использования
3. **Дополнительные функции**: Рассмотреть добавление:
   - Экспорт данных о подписчиках
   - Анализ активности подписчиков
   - Сегментация пользователей по различным критериям
   - Интеграция с аналитическими инструментами

---

*Документ обновлен: 2026-02-02*  
*Автор: KODA AI Assistant*  
*Проект: Giveaway Bot - Парсинг подписчиков Telegram каналов*