# Модуль dialogs

Модуль `dialogs` содержит реализацию сложных интерфейсов администрирования на основе библиотеки **aiogram-dialog**, которая предоставляет высокоуровневую абстракцию для создания многошаговых диалогов в Telegram-ботах. В отличие от традиционных FSM (Finite State Machine), `aiogram-dialog` обеспечивает более удобную и гибкую работу с многошаговыми сценариями.

## Основные преимущества aiogram-dialog

- **Декларативный подход**: диалоги описываются через компоненты `Window` и `Dialog`, что делает код более читаемым и легко поддерживаемым.
- **Автоматическое управление стеком состояний**: упрощает навигацию между шагами диалога.
- **Встроенные виджеты**: кнопки, ввод текста, отображение данных и др.
- **Гибкий механизм получения данных** (`getter`) для динамического рендеринга окон.
- **Лучшая разделение логики**: обработчики событий и логика отображения отделены.

## Структура модуля

- `__init__.py` - инициализация пакета и регистрация всех диалогов
- `admin_main.py` - главное меню администратора
- `admins.py` - управление администраторами бота
- `channels.py` - управление Telegram-каналами
- `giveaway_create.py` - мастер создания розыгрыша
- `giveaway_view.py` - просмотр розыгрышей (активных/завершённых)
- `giveaway_edit.py` - редактирование и удаление розыгрышей
- `mailing.py` - рассылка сообщений через бота

## Описание основных диалогов

### admin_main.py — Главное админ-меню

Центральный интерфейс для администраторов, предоставляющий доступ к другим диалогам:

- Кнопки для перехода к управлению:
  - Администраторами бота
  - Каналами
  - Розыгрышами
  - Рассылкой
- Использует `Start`-кнопки для запуска других диалогов
- Состояние: `AdminDialogStates.MAIN_MENU`

### admins.py — Управление администраторами

Полный цикл управления администраторами бота:

- Просмотр полного списка администраторов
- Добавление нового администратора по ID или username
- Выбор администратора для удаления (исключая главного)
- Автоматическая проверка и обновление профиля при добавлении
- Поддержка возврата в главное меню на каждом этапе
- Использование `MessageInput` для ввода данных
- Состояния: `AdminDialogStates`

### channels.py — Управление каналами

Функционал для добавления и удаления каналов:

- Просмотр списка добавленных каналов
- Добавление канала:
  - По ссылке или username
  - Через пересылку сообщения из канала
- Проверка прав бота в канале при добавлении
- Выбор канала для удаления
- Подтверждение удаления
- Поддержка динамического получения данных (`getter`)
- Состояния: `ChannelDialogStates`

### giveaway_create.py — Создание розыгрыша

Пошаговый мастер создания розыгрыша с валидацией:

- Ввод заголовка и описания
- Добавление медиа (фото, видео и др.)
- Выбор количества призовых мест
- Выбор канала для публикации
- Установка времени окончания
- Персональное сообщение победителям (с поддержкой HTML)
- Превью розыгрыша перед публикацией
- Подтверждение с отображением сообщения для победителей
- Состояния: `CreateGiveawayStates`

### giveaway_view.py — Просмотр розыгрышей

Интерфейс просмотра розыгрышей:

- Выбор типа: активные или завершённые
- Просмотр списка активных розыгрышей
- Просмотр завершённых с пагинацией
- Окно деталей розыгрыша с информацией:
  - Статус, количество участников, победители
  - Кнопки для управления (если розыгрыш активен)
- Навигация между шагами и возврат в главное меню
- Состояния: `ViewGiveawaysStates`

### giveaway_edit.py — Редактирование розыгрышей

Редактирование существующих розыгрышей:

- Выбор розыгрыша для редактирования
- Меню редактирования с выбором поля:
  - Заголовок, описание, медиа, время, сообщение победителям
- Интерактивное редактирование каждого поля
- Обновление поста розыгрыша в канале
- Интерфейс удаления розыгрыша с подтверждением
- Состояния: `EditGiveawayStates`

### mailing.py — Рассылка сообщений

Инструмент массовой рассылки:

- Выбор канала или списка каналов для рассылки
- Ввод текста и/или прикрепление медиа
- Настройка скорости отправки и задержки
- Прогресс-бар отправки
- Отчёт о результатах (успешно/неудачно)
- Поддержка форматирования и ссылок
- Состояния: `MailingStates`

## Регистрация диалогов

Все диалоги регистрируются в `Dispatcher` через функцию `register_dialogs(dp)`, которая находится в `dialogs/__init__.py`:

- Каждый диалог — это экземпляр `Dialog`
- Диалоги подключаются к диспетчеру через `dp.include_router()`
- В `main.py` вызывается:
  ```python
  register_dialogs(dp)
  setup_dialogs(dp)  # инициализация aiogram-dialog
  ```

## Зависимости

Модуль зависит от следующих компонентов проекта:

- `aiogram-dialog` — основная библиотека для диалогов
- `states.admin_states` — определение состояний `StatesGroup`
- `texts.messages` — тексты сообщений и кнопок
- `utils.keyboards` — вспомогательные клавиатуры (при необходимости)
- `database.database` — работа с базой данных (добавление, удаление и т.д.)
- `utils.scheduler` — планирование завершения розыгрышей
- `utils.datetime_utils` — обработка дат и времени

## Преимущества над старыми handlers

По сравнению с устаревшим подходом на основе ручных FSM в `handlers/`:

- **Меньше кода**: устранены дублирующие обработчики
- **Более стабильная навигация**: меньше ошибок при переключении между состояниями
- **Гибкость интерфейса**: динамическое обновление окон через `getter`
- **Лучшая поддержка**: `aiogram-dialog` активно развивается и интегрирован в экосистему aiogram
- **Простота добавления новых шагов**: легко расширять диалоги без переписывания логики

Документация создана на основе анализа кода от 2026-02-02.