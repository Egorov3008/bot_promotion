# Модуль pyrogram_app

Модуль `pyrogram_app` содержит компоненты для работы с Telegram User Bot через Pyrogram API на основе MTProto. Он используется для выполнения операций, недоступных через Bot API, таких как анализ реакций и отправка персональных сообщений победителям розыгрышей.

## Архитектура модуля

```
pyrogram_app/
├── pyro_client.py      # Основной клиент Pyrogram
├── parsing_mode.py     # Режим парсинга и мониторинга активности
├── mailing_mode.py     # Режим массовой рассылки
└── README.md           # Подробная документация
```

## PyrogramClient - Основной клиент

Централизованная точка управления User Bot, реализованная как синглтон:

- Управление жизненным циклом клиента (запуск/остановка)
- Единая точка входа через `setup_pyrogram()` и `get_pyrogram_client()`
- Обработка базовых операций: отправка сообщений, получение реакций
- Мониторинг активности пользователей через обработку raw-обновлений

### Ключевые функции:

- `start()` - безопасный запуск клиента с автоматической авторизацией
- `stop()` - корректная остановка и освобождение ресурсов
- `send_message(chat_id, text)` - отправка персональных сообщений
- Внутренний `RawUpdateHandler` для отслеживания реакций пользователей в каналах

## ParsingMode - Парсинг и мониторинг

Функционал для анализа активности в каналах:

- Полный и инкрементальный парсинг подписчиков каналов
- Проверка прав администратора в канале
- Мониторинг активности пользователей (комментарии, реакции)
- Сбор статистики по каналу и участникам
- Поддержка пагинации при работе с большими каналами

Информация используется для:
- Валидации участия в розыгрышах
- Формирования отчётов
- Анализа вовлечённости аудитории

## MailingMode - Рассылка сообщений

Инструмент для массовой персональной рассылки:

- Отправка сообщений списку пользователей
- Поддержка персонализированных сообщений
- Управление скоростью отправки (анти-Flood)
- Обработка всех типов ошибок (блокировка, удаление пользователя и др.)
- Сбор статистики по доставке сообщений
- Функция оценки времени рассылки

Используется для:
- Уведомления победителей розыгрышей
- Рассылки персональных сообщений администратором
- Массовых информационных оповещений

## Интеграция с другими модулями

### С модулем handlers

- При создании розыгрыша: проверка прав бота в канале через `ParsingMode`
- При завершении розыгрыша: уведомление победителей через `MailingMode`

### С модулем database

- Активность пользователей (реакции, комментарии) сохраняется в `channel_subscribers.last_activity`
- Данные о подписчиках канала используются для статистики и валидации

### С модулем utils

- `get_winers_keyboard()` использует данные из Pyrogram для создания ссылок на победителей
- Планировщик использует Pyrogram для отправки напоминаний

## Конфигурация

Для работы модуля необходимы переменные окружения в `.env`:

```env
API_ID=ваш_api_id
API_HASH=ваш_api_hash
PHONE_NUMBER=+79001234567
SESSION_NAME=pyrogram_session
```

## Безопасность

- Сессия хранится в файле `pyrogram_session.session`, который должен быть защищён от несанкционированного доступа
- Все операции с сообщениями имеют встроенную защиту от Flood Wait через случайные задержки
- Автоматическая обработка блокировок пользователей и других ошибок

## Особенности реализации

- Использование raw-запросов MTProto для получения реакций на сообщения (недоступно в Bot API)
- Паттерн синглтон для управления единственным экземпляром клиента
- Асинхронная архитектура с поддержкой background-задач
- Подробное логирование всех операций и ошибок

Документация создана на основе анализа кода от 2026-02-02.