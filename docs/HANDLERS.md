# Модуль handlers

Модуль `handlers` содержит все обработчики (хендлеры) для Telegram-бота, управляющего розыгрышами в каналах. Хендлеры разделены по функциональности на три основных файла.

## Структура модуля

- `__init__.py` - инициализация пакета
- `admin_handlers.py` - обработчики для управления администраторами и каналами
- `basic_handlers.py` - базовые обработчики для пользователей и стартовых команд
- `chat_member_handlers.py` - обработчики событий участников канала
- `giveaway_handlers.py` - обработчики для создания, просмотра и управления розыгрышами

## Описание файлов

### chat_member_handlers.py

Содержит обработчики событий участников каналов:

- **Отслеживание изменений подписки:**
  - Автоматическое сохранение новых участников каналов в базу данных при присоединении
  - Отметка отписавшихся пользователей при выходе из канала
  - Обработка события `chat_member` из Telegram
  - Фильтрация по типу чата (только каналы)
  - Определение присоединения по изменению статуса с 'left'/'kicked' на 'member'/'restricted'
  - Определение отписки по изменению статуса с 'member'/'restricted' на 'left'/'kicked'

**Особенности работы:**
- Сохраняет подписчиков в базу данных, но не добавляет их в участники розыгрыша
- Использует функции `add_channel_subscriber` и `remove_channel_subscriber` из `database.database` для управления состоянием подписки
- Поддерживает отслеживание полного жизненного цикла подписки (подписка/отписка)
- Логирует все операции с подписчиками
- Обрабатывает все возможные статусы участников каналов (member, restricted, left, kicked)

### admin_handlers.py

Содержит обработчики для управления администраторами бота и Telegram-каналами:

- **Управление администраторами:**
  - Просмотр списка администраторов
  - Добавление новых администраторов по ID
  - Удаление администраторов (кроме главного)
  - Подтверждение действий

- **Управление каналами:**
  - Просмотр списка добавленных каналов
  - Добавление каналов двумя способами:
    - По ссылке/username
    - Через пересылку сообщения из канала
  - Удаление каналов
  - Проверка прав бота в канале

Основные состояния FSM находятся в `states.admin_states`.

### basic_handlers.py

Содержит базовые обработчики для всех пользователей:

- Обработчик команды `/start` - приветственное сообщение
- Обработчик команды `/admin` - вход в админ-панель
- Обработчик команды `/clear` - очистка сообщений
- Обработчик участия в розыгрыше (`participate_`)
- Обработчик неизвестных сообщений
- Кнопка возврата в главное меню

Также содержит логику проверки подписки пользователя на канал перед участием в розыгрыше.

### giveaway_handlers.py

Основной модуль для работы с розыгрышами:

- **Создание розыгрыша:**
  - Ввод заголовка, описания, медиа
  - Выбор количества призовых мест
  - Выбор канала для публикации
  - Установка времени окончания
  - Подтверждение и публикация в канале

- **Просмотр розыгрышей:**
  - Просмотр активных и завершенных розыгрышей
  - Детали розыгрыша с информацией о победителях
  - Пагинация для завершенных розыгрышей

- **Управление розыгрышами:**
  - Редактирование полей розыгрыша (заголовок, описание, медиа, время)
  - Удаление розыгрышей с подтверждением
  - Автоматическое завершение по времени

- **Дополнительная функциональность:**
  - Обновление поста розыгрыша при редактировании
  - Планирование завершения розыгрыша
  - Уведомления о завершении

## Зависимости

Модуль зависит от следующих компонентов проекта:

- `states.admin_states` - состояния FSM для управления администраторами и розыгрышами
- `texts.messages` - тексты сообщений и кнопок
- `utils.keyboards` - генерация инлайн-клавиатур
- `database.database` - взаимодействие с базой данных (включая функции `add_channel_subscriber` и `remove_channel_subscriber` для управления подписчиками каналов)
- `utils.scheduler` - планирование задач
- `utils.datetime_utils` - работа с датами и временем

## Регистрация хендлеров

Каждый файл содержит функцию `setup_<module>_handlers(dp: Dispatcher)`, которая регистрирует соответствующие хендлеры в диспетчере. Основная регистрация происходит в `run.py`.
