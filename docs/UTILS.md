, как требуется.<code>
# Модуль utils

Модуль `utils` содержит вспомогательные функции и утилиты для Telegram-бота по управлению розыгрышами. Эти функции обеспечивают работу с датами, планирование задач, формирование клавиатур и другие вспомогательные операции.

## Структура модуля

- `__init__.py` - инициализация пакета
- `datetime_utils.py` - работа с датами и временем
- `keyboards.py` - создание инлайн-клавиатур
- `scheduler.py` - планирование задач и автоматизация

## Описание файлов

### datetime_utils.py

Содержит утилиты для работы с датами и временем, включая конвертацию между часовыми поясами:

- `parse_datetime(date_string: str) -> datetime`:
  - Парсит строку в формате "ДД.ММ.ГГГГ ЧЧ:ММ" в объект datetime
  - Автоматически конвертирует время из московского часового пояса (настройка в config.TIMEZONE) в UTC для хранения в базе данных
  - Выбрасывает ValueError при неверном формате

- `format_datetime(dt: datetime) -> str`:
  - Форматирует объект datetime в читаемую строку с указанием московского времени
  - Автоматически конвертирует UTC время в московское для отображения пользователю
  - Добавляет суффикс "(МСК)" для ясности

- `is_future_datetime(dt: datetime) -> bool`:
  - Проверяет, находится ли указанная дата в будущем относительно текущего времени
  - Используется для валидации времени окончания розыгрышей

- `get_moscow_time() -> datetime`:
  - Возвращает текущее время в московском часовом поясе
  - Используется для отображения текущего времени пользователю

### keyboards.py

Содержит функции для генерации инлайн-клавиатур бота:

- Все функции возвращают объект `InlineKeyboardMarkup`
- Клавиатуры используют тексты из `texts.messages.BUTTONS`
- Поддерживают динамическое формирование на основе переданных данных

Основные функции:

- `get_main_admin_keyboard()` - главная клавиатура админ-панели
- `get_back_to_menu_keyboard()` - кнопка возврата в главное меню
- `get_skip_media_keyboard()` - клавиатура для пропуска добавления медиа
- `get_confirm_keyboard()` - клавиатура подтверждения действий
- `get_participate_keyboard(giveaway_id, participants_count)` - кнопка участия в розыгрыше с отображением количества участников
- `get_giveaway_details_keyboard(giveaway)` - клавиатура действий для конкретного розыгрыша (редактирование, удаление)
- `get_channels_keyboard(channels)` - выбор канала из списка
- `get_giveaway_types_keyboard()` - клавиатура выбора типа розыгрышей (активные/завершенные)
- `get_giveaways_list_keyboard(giveaways)` - список розыгрышей с пагинацией
- `get_edit_fields_keyboard()` - клавиатура выбора поля для редактирования розыгрыша
- `get_admin_management_keyboard()` - клавиатура управления администраторами
- `get_admins_list_keyboard(admins, action)` - список администраторов с возможностью удаления
- `get_channel_management_keyboard()` - клавиатура управления каналами
- `get_add_channel_method_keyboard()` - выбор способа добавления канала (по ссылке или пересылке)
- `get_channels_list_keyboard(channels, action)` - список каналов с возможностью удаления
- `get_delete_confirmation_keyboard(giveaway_id)` - подтверждение удаления розыгрыша
- `get_finished_pagination_keyboard(page, total_pages)` - пагинация для списка завершенных розыгрышей
- `get_finished_list_with_pagination_keyboard(giveaways, page, total_pages)` - единая клавиатура со списком завершенных розыгрышей и пагинацией
- `get_winers_keyboard(winer_data)` - асинхронная клавиатура с ссылками на победителей розыгрыша для быстрого доступа

Особенности:

- Некоторые клавиатуры асинхронные (например, `get_winers_keyboard`), так как могут требовать дополнительной обработки данных
- Клавиатура `get_winers_keyboard` генерирует кнопки с deep linking-ссылками на пользователей Telegram (tg://user?id=12345)
- В кнопках отображаются имена пользователей, приоритет: username -> first_name -> full_name
- Поддерживается пагинация для списков с большим количеством элементов
- Все клавиатуры обеспечивают навигацию назад и выход в главное меню
- Клавиатуры возвращают кнопку "Назад в меню" для завершения сценария и возврата в основное меню

### scheduler.py

Модуль для планирования и автоматизации задач бота:

- Использует `AsyncIOScheduler` из библиотеки apscheduler
- Работает в часовом поясе UTC

Основные функции:

- `setup_scheduler(bot)`:
  - Инициализирует и запускает планировщик
  - Восстанавливает запланированные задачи для активных розыгрышей при старте бота
  - Настраивает ежедневную очистку завершенных розыгрышей старше 15 дней

- `schedule_giveaway_finish(bot, giveaway_id, end_time)`:
  - Планирует автоматическое завершение розыгрыша в указанное время
  - Удаляет предыдущее запланированное завершение при повторном вызове
  - Добавляет имя задачи для лучшей идентификации в логах и статусе

- `schedule_reminders(bot, giveaway)`:
  - Планирует напоминания о розыгрыше за 3 дня, 1 день и 3 часа до окончания
  - Использует многоуровневую систему напоминаний для повышения вовлеченности
  - Проверяет актуальность розыгрыша перед отправкой напоминания

- `send_reminder(bot, giveaway_id, level)`:
  - Отправляет напоминание в канал о предстоящем окончании розыгрыша
  - Предотвращает дублирование напоминаний через внутренний словарь REMINDER_SETTINGS
  - Форматирует сообщение с актуальной информацией о количестве участников
  - Добавляет клавиатуру участия в сообщение

- `finish_giveaway_task(bot, giveaway_id)`:
  - Основная задача завершения розыгрыша
  - Случайным образом выбирает победителей из участников
  - Проверяет актуальность подписки участников на канал
  - Публикует результаты в канале
  - Обрабатывает случаи отсутствия участников
  - Отправляет детализированный отчет о результатах администратору канала
  - Использует клавиатуру с ссылками на победителей для упрощения взаимодействия
  - Отправляет персональное сообщение победителям через Pyrogram клиент, если он запущен
  - Включает в сообщение администратору статус доставки личных сообщений (✅ Успешно / ❌ Не доставлено)
  - Использует специальное сообщение для победителей из поля `message_winner` розыгрыша, с резервным сообщением по умолчанию если оно не задано

- `check_user_subscription(bot, user_id, channel_id) -> bool`:
  - Проверяет, подписан ли пользователь на указанный канал
  - Возвращает True, если пользователь является участником, администратором или создателем канала
  - Обрабатывает исключения и возвращает False при ошибках

- `cancel_giveaway_schedule(giveaway_id)`:
  - Отменяет запланированное завершение розыгрыша
  - Используется при редактировании времени окончания или удалении розыгрыша

- `disable_all_reminders(giveaway_id)`:
  - Отключает все напоминания для розыгрыша
  - Удаляет запланированные задачи напоминаний

- `cleanup_old_finished(days)`:
  - Очищает завершенные розыгрыши старше указанного количества дней из базы данных
  - Выполняется ежедневно как фоновая задача

- `get_scheduler_status() -> dict`:
  - Возвращает текущий статус планировщика для диагностики
  - Включает информацию о количестве и деталях запланированных задач
  - Возвращает имена и временные метки задач для более детального мониторинга

## Зависимости

Модуль зависит от следующих компонентов проекта:

- `config` - для получения настроек (в основном часового пояса)
- `texts.messages` - для текстов сообщений и кнопок
- `database.database` - для взаимодействия с базой данных (получение розыгрышей, участников и т.д.)
- `aiogram` - для работы с ботом и отправки сообщений
- `apscheduler` - для планирования задач
- `pytz` - для работы с часовыми поясами
- `dotenv` - для загрузки переменных окружения (через config)