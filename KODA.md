# KODA - Документация проекта Giveaway Bot

## Обзор проекта

**Giveaway Bot** — это Telegram бот для организации и проведения розыгрышей в каналах. Проект представляет собой полнофункциональное приложение с асинхронной архитектурой, использующее два Telegram API:

- **Aiogram 3** — Telegram Bot API для взаимодействия с пользователями через команды и кнопки
- **Pyrogram** — Telegram Client API для работы с каналами и пользователями на уровне пользователя

### Основные технологии

- **Python 3.8+** — основной язык разработки
- **Aiogram 3.24.0** — фреймворк для создания Telegram ботов с FSM (Finite State Machine)
- **Pyrogram** — клиентская библиотека Telegram для работы с API MTProto
- **SQLAlchemy 2.0.25** — асинхронный ORM для работы с базами данных
- **aiosqlite 0.19.0** — асинхронный драйвер SQLite
- **APScheduler 3.10.4** — планировщик задач для автоматического завершения розыгрышей
- **pytest** — фреймворк для тестирования
- **python-dotenv** — управление переменными окружения

### Архитектура проекта

Проект построен по модульному принципу с чётким разделением ответственности:

```
giveaway_bot/
├── handlers/          # Обработчики команд и callback-запросов
│   ├── admin_handlers.py         # Админ-команды
│   ├── basic_handlers.py         # Базовые команды (start, clear)
│   ├── chat_member_handlers.py   # Обработка событий чата
│   └── giveaway_handlers.py      # Управление розыгрышами
├── database/          # Работа с базой данных
│   ├── models.py                 # SQLAlchemy модели
│   └── database.py               # Инициализация и сессии БД
├── middlewares/       # Middleware для обработки запросов
│   ├── auth.py                   # Проверка прав администратора
│   └── pyro.py                   # Интеграция Pyrogram клиента
├── pyrogram_app/      # Конфигурация Pyrogram клиента
│   └── pyro_client.py            # Настройка и запуск клиента
├── states/            # Состояния FSM
│   └── admin_states.py           # Состояния для админ-диалогов
├── texts/             # Текстовые сообщения
│   └── messages.py               # Сообщения бота
├── utils/             # Вспомогательные утилиты
│   ├── keyboards.py              # Inline-клавиатуры
│   ├── scheduler.py              # Настройка APScheduler
│   ├── statistics.py             # Статистика розыгрышей
│   └── datetime_utils.py         # Работа с датами и временем
├── tests/             # Тесты
│   ├── conftest.py               # Фикстуры pytest
│   ├── test_*.py                 # Модульные тесты
│   └── database/                 # Тесты БД
├── config.py          # Конфигурация проекта
├── main.py            # Основной файл запуска
├── run.py             # Альтернативный файл запуска
├── requirements.txt   # Зависимости Python
├── pytest.ini         # Конфигурация pytest
└── .env               # Переменные окружения (создаётся локально)
```

### Основные функции

1. **Управление розыгрышами**
   - Создание розыгрышей с медиа-контентом (фото, видео, анимация)
   - Установка времени завершения
   - Управление количеством призовых мест
   - Автоматический выбор победителей

2. **Участие в розыгрышах**
   - Подписка на канал для участия
   - Проверка подписки при участии
   - Отображение списка участников

3. **Управление администраторами**
   - Добавление и удаление администраторов
   - Проверка прав доступа через middleware
   - Главный администратор (MAIN_ADMIN_ID)

4. **Управление каналами**
   - Добавление каналов для розыгрышей
   - Мониторинг подписчиков
   - Отслеживание событий чата (вход/выход)

5. **Автоматизация**
   - APScheduler для автоматического завершения розыгрышей
   - Планированные задачи для проверки подписок
   - Автоматический выбор победителей

## Сборка и запуск

### Требования

- Python 3.8 или выше
- pip (менеджер пакетов Python)
- Учетная запись Telegram с номером телефона (для Pyrogram)

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Конфигурация

Создайте файл `.env` в корневой директории проекта со следующими переменными:

```env
# Aiogram Bot
BOT_TOKEN=ваш_бот_токен
MAIN_ADMIN_ID=ваш_telegram_id
DATABASE_URL=sqlite:///giveaway_bot.db
TIMEZONE=Europe/Moscow

# Pyrogram Client
API_ID=ваш_api_id
API_HASH=ваш_api_hash
PHONE_NUMBER=+79001234567
SESSION_NAME=pyrogram_session
```

**Как получить API_ID и API_HASH:**
1. Перейдите на https://my.telegram.org
2. Войдите под своим номером телефона
3. Перейдите в раздел "API development tools"
4. Создайте новое приложение и скопируйте данные

### Запуск бота

**Основной способ (main.py):**
```bash
python main.py
```

**Альтернативный способ (run.py):**
```bash
python run.py
```

Оба файла запускают бота с интеграцией Aiogram и Pyrogram. Различия в деталях инициализации Pyrogram клиента.

### Остановка бота

Нажмите `Ctrl+C` в терминале. Бот корректно остановит все клиенты и закроет соединения с базой данных.

## Тестирование

### Запуск тестов

```bash
pytest
```

### Конфигурация тестов

Файл `pytest.ini` содержит настройки для pytest:
- `asyncio_mode = auto` — автоматический режим для асинхронных тестов
- Фильтрация предупреждений от pydantic и SQLAlchemy

### Покрытие тестами

Проект содержит модульные тесты для основных компонентов:
- `test_admin_handlers.py` — тесты админ-команд
- `test_basic_handlers.py` — тесты базовых команд
- `test_giveaway_handlers.py` — тесты управления розыгрышами
- `test_chat_member_handlers.py` — тесты обработки событий чата
- `test_scheduler.py` — тесты планировщика

## Правила разработки

### Стиль кодирования

1. **Асинхронность**
   - Все функции работы с БД и Telegram API должны быть асинхронными (`async def`)
   - Используйте `await` для вызова асинхронных функций
   - Не блокируйте event loop синхронными операциями

2. **SQLAlchemy ORM**
   - Используйте декларативный стиль для определения моделей
   - Все запросы к БД выполняйте через асинхронные сессии
   - Используйте связи (`relationship`) для работы со связанными данными

3. **Aiogram FSM**
   - Используйте FSM для многошаговых диалогов (создание розыгрыша и т.д.)
   - Определяйте состояния в `states/admin_states.py`
   - Очищайте состояния после завершения диалога

4. **Middleware**
   - Используйте middleware для проверки прав доступа
   - `AdminMiddleware` — проверка, является ли пользователь администратором
   - `PyrogramMiddleware` — интеграция Pyrogram клиента в контекст

5. **Логирование**
   - Используйте модуль `logging` для логирования
   - Уровень логирования: `INFO` по умолчанию
   - Логи записываются в файл `bot.log` и выводятся в консоль

### Структура хендлеров

Хендлеры регистрируются в `handlers/__init__.py` через функцию `setup_handlers()`:

```python
def setup_handlers(dp: Dispatcher):
    # Сначала админские и розыгрыши (FSM), чтобы они имели приоритет
    setup_admin_handlers(dp)
    setup_giveaway_handlers(dp)
    chat_member_handlers(dp)
    
    # В самом конце — базовые (в т.ч. неизвестная команда)
    setup_basic_handlers(dp)
```

### Работа с базой данных

**Инициализация:**
```python
from database.database import init_db
await init_db()
```

**Использование сессии:**
```python
from database.database import get_async_session
async for session in get_async_session():
    # Работа с сессией
    pass
```

**Пример запроса:**
```python
from sqlalchemy import select
from database.models import Giveaway

async for session in get_async_session():
    result = await session.execute(select(Giveaway).where(Giveaway.status == "active"))
    giveaways = result.scalars().all()
```

### Создание миграций

Проект использует SQLAlchemy без миграций (alembic). При изменении моделей:

1. Удалите старый файл базы данных (если используется SQLite)
2. Перезапустите бота — таблицы будут созданы автоматически

### Добавление новых функций

1. Создайте новый хендлер в соответствующем файле в `handlers/`
2. Зарегистрируйте его в `handlers/__init__.py`
3. При необходимости добавьте состояние в `states/admin_states.py`
4. Добавьте текстовые сообщения в `texts/messages.py`
5. Создайте клавиатуру в `utils/keyboards.py` (если нужно)
6. Напишите тесты в `tests/`

### Безопасность

1. **Переменные окружения**
   - Никогда не коммитьте `.env` файл
   - Используйте `.env.example` как шаблон

2. **Проверка прав доступа**
   - Все административные функции должны проходить через `AdminMiddleware`
   - Проверяйте `MAIN_ADMIN_ID` для критических операций

3. **Валидация данных**
   - Проверяйте входные данные от пользователей
   - Используйте SQLAlchemy модели для валидации структуры данных

## Работа с проектом

### Добавление нового админа

1. Добавьте запись в таблицу `admins` через базу данных или через бота (если есть команда)
2. Убедитесь, что пользователь имеет права администратора в канале

### Создание розыгрыша

1. Добавьте канал через админ-панель
2. Создайте розыгрыш с указанием:
   - Заголовка и описания
   - Медиа-файла (опционально)
   - Времени завершения
   - Количество призовых мест
3. Розыгрыш автоматически завершится по расписанию через APScheduler

### Мониторинг

- Логи бота: `bot.log`
- База данных: `giveaway_bot.db` (SQLite)
- Сессия Pyrogram: `pyrogram_session.session` (создаётся автоматически)

## Устранение неполадок

### Ошибка: "BOT_TOKEN не найден!"

Решение: Проверьте, что файл `.env` существует и содержит переменную `BOT_TOKEN`.

### Ошибка: "Для Pyrogram нужны: API_ID, API_HASH, PHONE_NUMBER"

Решение: Добавьте missing переменные в `.env` файл.

### Ошибка при подключении к базе данных

Решение: Проверьте строку подключения `DATABASE_URL` в `.env`. Для SQLite убедитесь, что приложение имеет права на запись в директорию.

### Pyrogram не запускается

Решение:
1. Убедитесь, что номер телефона указан в правильном формате: `+79001234567`
2. При первом запуске потребуется ввести код подтверждения из Telegram
3. Проверьте, что `API_ID` и `API_HASH` верные

## Дополнительные ресурсы

- [Aiogram документация](https://docs.aiogram.dev/)
- [Pyrogram документация](https://docs.pyrogram.org/)
- [SQLAlchemy документация](https://docs.sqlalchemy.org/)
- [APScheduler документация](https://apscheduler.readthedocs.io/)

## Лицензия

Проект разработан для образовательных целей. Используйте в соответствии с условиями лицензий используемых библиотек.
